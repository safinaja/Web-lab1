package org.example;

import com.fastcgi.FCGIInterface;
import java.util.*;
        import java.util.logging.Logger;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.nio.charset.StandardCharsets;

public class Main {
    private static final double MIN_X = -5;
    private static final double MAX_X = 5;
    private static final double MIN_R = 1;
    private static final double MAX_R = 4;
    private static final Set<Double> VALID_Y_VALUES = Set.of(-3.0,-2.0,-1.0,0.0,1.0,2.0,3.0,4.0,5.0);
    private static final Logger logger = Logger.getLogger(Main.class.getName());
    private static final List<Map<String, Object>> results = new ArrayList<>();

    public static void main(String[] args) {
        logger.info("Starting FastCGI server...");

        FCGIInterface fcgi = new FCGIInterface();
        logger.info("FCGIInterface created");

        while (fcgi.FCGIaccept() >= 0) {
            try {
                logger.info("Request accepted, processing...");
                run();
            } catch (Exception e) {
                logger.warning("Error: " + e.getMessage());
                sendError("Internal server error: " + e.getMessage());
            }
        }
    }

    public static void run() {
        long startTime = System.currentTimeMillis();

        try {

            if (FCGIInterface.request == null) {
                sendError("FastCGI request not initialized");
                return;
            }

            Properties params = FCGIInterface.request.params;
            if (params == null) {
                sendError("No request parameters available");
                return;
            }

            String requestMethod = params.getProperty("REQUEST_METHOD");
            logger.info("Request method: " + requestMethod);

            if (!"POST".equalsIgnoreCase(requestMethod)) {
                sendError("Invalid request method. Only POST is supported");
                return;
            }

            String contentLengthStr = params.getProperty("CONTENT_LENGTH");
            if (contentLengthStr == null || contentLengthStr.isEmpty()) {
                sendError("No content length");
                return;
            }

            int contentLength = Integer.parseInt(contentLengthStr);
            logger.info("Content length: " + contentLength);

            if (contentLength <= 0) {
                sendError("Empty request body");
                return;
            }


            byte[] postData = new byte[contentLength];
            int bytesRead = 0;
            while (bytesRead < contentLength) {
                int result = System.in.read(postData, bytesRead, contentLength - bytesRead);
                if (result == -1) break;
                bytesRead += result;
            }

            String postBody = new String(postData, StandardCharsets.UTF_8);
            logger.info("POST body: " + postBody);
            Map<String, List<String>> paramsMap = parseQuery(postBody);


            if (!paramsMap.containsKey("x") || !paramsMap.containsKey("y") || !paramsMap.containsKey("r")) {
                sendError("Missing parameters: x, y, r are required");
                return;
            }


            double x = Double.parseDouble(paramsMap.get("x").get(0));
            double y = Double.parseDouble(paramsMap.get("y").get(0));
            double r = Double.parseDouble(paramsMap.get("r").get(0));

            logger.info(String.format("Parsed parameters: x=%.2f, y=%.2f, r=%.2f", x, y, r));


            if (!isValidX(x)) {
                sendError("X must be between " + MIN_X + " and " + MAX_X);
                return;
            }

            if (!isValidY(y)) {
                sendError("Y must be one of: -3, -2, -1, 0, 1, 2, 3, 4, 5");
                return;
            }

            if (!isValidR(r)) {
                sendError("R must be between " + MIN_R + " and " + MAX_R);
                return;
            }


            boolean hit = checkPoint(x, y, r);
            long executionTime = System.currentTimeMillis() - startTime;
            String currentTime = LocalDateTime.now().format(DateTimeFormatter.ofPattern("dd-MM-yyyy HH:mm:ss"));


            Map<String, Object> result = new HashMap<>();
            result.put("x", x);
            result.put("y", y);
            result.put("r", r);
            result.put("hit", hit);
            result.put("currentTime", currentTime);
            result.put("executionTime", executionTime);

            results.add(result);

            logger.info("Point check result: " + (hit ? "HIT" : "MISS"));
            sendResultsResponse();

        } catch (NumberFormatException e) {
            logger.warning("Number format error: " + e.getMessage());
            sendError("Invalid number format in parameters");
        } catch (Exception e) {
            logger.warning("Unexpected error: " + e.getMessage());
            sendError("Internal server error: " + e.getMessage());
        }
    }

    private static boolean isValidX(double x) {
        return x >= MIN_X && x <= MAX_X;
    }

    private static boolean isValidR(double r) {
        return r >= MIN_R && r <= MAX_R;
    }

    private static boolean isValidY(double y) {
        return VALID_Y_VALUES.contains(y);
    }

    public static void sendResultsResponse() {
        try {
            StringBuilder content = new StringBuilder();
            content.append("{\n");
            content.append("  \"results\": [\n");

            for (int i = 0; i < results.size(); i++) {
                Map<String, Object> result = results.get(i);
                content.append("    {\n");
                content.append("      \"x\": ").append(result.get("x")).append(",\n");
                content.append("      \"y\": ").append(result.get("y")).append(",\n");
                content.append("      \"r\": ").append(result.get("r")).append(",\n");
                content.append("      \"hit\": ").append(result.get("hit")).append(",\n");
                content.append("      \"timestamp\": \"").append(result.get("currentTime")).append("\",\n");
                content.append("      \"workTime\": ").append(result.get("executionTime")).append("\n");
                content.append("    }");
                if (i < results.size() - 1) {
                    content.append(",");
                }
                content.append("\n");
            }

            content.append("  ]\n");
            content.append("}");

            String contentStr = content.toString();
            byte[] contentBytes = contentStr.getBytes(StandardCharsets.UTF_8);


            System.out.println("Content-Type: application/json; charset=utf-8");
            System.out.println("Content-Length: " + contentBytes.length);
            System.out.println();
            System.out.print(contentStr);
            System.out.flush();

            logger.info("Response sent successfully");

        } catch (Exception e) {
            logger.warning("Error sending response: " + e.getMessage());

            try {
                String errorContent = "{\"error\":\"Failed to generate response\"}";
                byte[] errorBytes = errorContent.getBytes(StandardCharsets.UTF_8);
                System.out.println("Content-Type: application/json; charset=utf-8");
                System.out.println("Content-Length: " + errorBytes.length);
                System.out.println("Status: 500 Internal Server Error");
                System.out.println();
                System.out.print(errorContent);
                System.out.flush();
            } catch (Exception ex) {

                System.err.println("Critical error: " + ex.getMessage());
            }
        }
    }

    public static boolean checkPoint(double x, double y, double r) {

        if (x >= 0 && x <= r/2 && y >= 0 && y <= r) {
            return true;
        }


        if (x <= 0 && y <= 0 && (x*x + y*y) <= r*r) {
            return true;
        }


        if (x >= 0 && y <= 0 && y >= x - r/2) {
            return true;
        }

        return false;
    }

    public static Map<String, List<String>> parseQuery(String query) {
        Map<String, List<String>> map = new HashMap<>();
        if (query == null || query.isEmpty()) {
            return map;
        }

        String[] pairs = query.split("&");
        for (String pair : pairs) {
            String[] keyValue = pair.split("=");
            if (keyValue.length == 2) {
                String key = keyValue[0];
                String value = keyValue[1];
                map.computeIfAbsent(key, k -> new ArrayList<>()).add(value);
            }
        }
        return map;
    }

    public static void sendError(String message) {
        try {
            String content = "{\"error\":\"" + message + "\"}";
            byte[] contentBytes = content.getBytes(StandardCharsets.UTF_8);
            System.out.println("Content-Type: application/json; charset=utf-8");
            System.out.println("Content-Length: " + contentBytes.length);
            System.out.println("Status: 400 Bad Request");
            System.out.println();
            System.out.print(content);
            System.out.flush();
        } catch (Exception e) {
            System.err.println("Error sending error response: " + e.getMessage());
        }
    }
}
